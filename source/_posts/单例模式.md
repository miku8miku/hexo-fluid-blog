---
title: Javaè®¾è®¡æ¨¡å¼è¯¦è§£ï¼šå•ä¾‹æ¨¡å¼çš„å…­ç§å®ç°æ–¹å¼
date: 2024-09-17 16:00:00
index_img: img/bg/design.jpg
category: Javaå¼€å‘
tags:
  - Java
  - è®¾è®¡æ¨¡å¼
  - å•ä¾‹æ¨¡å¼
  - çº¿ç¨‹å®‰å…¨
  - ç¼–ç¨‹æŠ€å·§
math: false
mermaid: true
---

> ğŸ¯ å•ä¾‹æ¨¡å¼æ˜¯é¢è¯•å’Œå®é™…å¼€å‘ä¸­æœ€å¸¸è§çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å•ä¾‹æ¨¡å¼çš„æ¦‚å¿µã€ä½¿ç”¨åœºæ™¯ï¼Œä»¥åŠå…­ç§ä¸åŒçš„å®ç°æ–¹å¼ï¼ŒåŒ…æ‹¬é¥¿æ±‰å¼ã€æ‡’æ±‰å¼ã€åŒé‡æ£€æŸ¥é”ç­‰ï¼Œå¸®åŠ©ä½ å½»åº•æŒæ¡è¿™ä¸€é‡è¦çš„è®¾è®¡æ¨¡å¼ã€‚

<!-- more -->

## ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦å•ä¾‹æ¨¡å¼ï¼Ÿ

åœ¨è½¯ä»¶å¼€å‘ä¸­ï¼Œæœ‰äº›å¯¹è±¡æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªå®ä¾‹ï¼Œä¾‹å¦‚ï¼š

- **è®¡æ•°å™¨**ï¼šæ•´ä¸ªåº”ç”¨ä¸­å¦‚æœå­˜åœ¨å¤šä¸ªè®¡æ•°å™¨å®ä¾‹ï¼Œä¼šäº§ç”Ÿæ•°æ®æ··ä¹±
- **é…ç½®ç®¡ç†å™¨**ï¼šåº”ç”¨é…ç½®ä¿¡æ¯åº”è¯¥å…¨å±€ç»Ÿä¸€
- **çº¿ç¨‹æ± **ï¼šé¿å…é‡å¤åˆ›å»ºï¼ŒèŠ‚çœç³»ç»Ÿèµ„æº
- **æ—¥å¿—ç®¡ç†å™¨**ï¼šç¡®ä¿æ—¥å¿—å†™å…¥çš„ä¸€è‡´æ€§
- **æ•°æ®åº“è¿æ¥æ± **ï¼šç®¡ç†æ•°æ®åº“è¿æ¥çš„å¤ç”¨

{% note primary %}
**å•ä¾‹æ¨¡å¼å®šä¹‰**ï¼šç¡®ä¿ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹æ¥è·å–è¯¥å®ä¾‹ã€‚
{% endnote %}

## ğŸ“Š å•ä¾‹æ¨¡å¼çš„åˆ†ç±»

å•ä¾‹æ¨¡å¼çš„å®ç°æ–¹å¼å¤§ä½“ä¸Šå¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼š

```mermaid
graph TD
    A[å•ä¾‹æ¨¡å¼] --> B[é¥¿æ±‰å¼]
    A --> C[æ‡’æ±‰å¼]
    B --> D[é™æ€å˜é‡]
    B --> E[é™æ€ä»£ç å—]
    C --> F[çº¿ç¨‹ä¸å®‰å…¨]
    C --> G[çº¿ç¨‹å®‰å…¨ - synchronized]
    C --> H[åŒé‡æ£€æŸ¥é”]
    C --> I[é™æ€å†…éƒ¨ç±»]
    C --> J[æšä¸¾å®ç°]
```

## ğŸ½ï¸ é¥¿æ±‰å¼å®ç°

é¥¿æ±‰å¼åœ¨ç±»åŠ è½½æ—¶å°±å®Œæˆå®ä¾‹åŒ–ï¼Œå› æ­¤æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

### æ–¹å¼ä¸€ï¼šé™æ€ä»£ç å—

å½“æˆ‘ä»¬æƒ³åˆ°ç±»åŠ è½½æ—¶å®Œæˆå®ä¾‹åŒ–æ“ä½œï¼Œå¾ˆå®¹æ˜“æƒ³åˆ° `static` å…³é”®å­—ï¼Œå¯ä»¥ä½¿ç”¨é™æ€ä»£ç å—æ¥å®ä¾‹åŒ–ï¼š

```java
public class Demo01 {
    private static Demo01 instance;
    
    // ç§æœ‰æ„é€ å‡½æ•°ï¼Œé˜²æ­¢å¤–éƒ¨å®ä¾‹åŒ–
    private Demo01() {
    }
 
    static {
        instance = new Demo01();
    }
 
    // å¯¹å¤–æä¾›ä¸€ä¸ªpublicçš„æ–¹æ³•æ¥è·å–å®ä¾‹
    public static Demo01 getInstance() {
        return instance;
    }
    
    public static void main(String[] args) {
        Demo01 instance = Demo01.getInstance();
        Demo01 instance1 = Demo01.getInstance();
        System.out.println(instance == instance1);
        System.out.println(instance.hashCode());
        System.out.println(instance1.hashCode());
    }
}
```

**è¿è¡Œç»“æœï¼š**
```
true
1265094477
1265094477
```

### æ–¹å¼äºŒï¼šé™æ€å˜é‡

æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨é™æ€å˜é‡æ–¹å¼æ¥å®ä¾‹åŒ–ï¼š

```java
public class Demo02 {
    // åœ¨ç±»åŠ è½½æ—¶å°±å®Œæˆå®ä¾‹åŒ–
    private static Demo02 instance = new Demo02();
    
    private Demo02() {
    }
 
    // å¯¹å¤–æä¾›ä¸€ä¸ªpublicæ–¹æ³•æ¥è·å–å®ä¾‹
    public static Demo02 getInstance() {
        return instance;
    }
 
    public static void main(String[] args) {
        Demo02 instance = Demo02.getInstance();
        Demo02 instance1 = Demo02.getInstance();
        System.out.println(instance == instance1);
        System.out.println(instance.hashCode());
        System.out.println(instance1.hashCode());
    }
}
```

{% note success %}
**é¥¿æ±‰å¼ä¼˜ç‚¹**ï¼š
- çº¿ç¨‹å®‰å…¨ï¼Œæ— éœ€è€ƒè™‘å¤šçº¿ç¨‹é—®é¢˜
- å®ç°ç®€å•ï¼Œä»£ç æ¸…æ™°

**é¥¿æ±‰å¼ç¼ºç‚¹**ï¼š
- æ— è®ºæ˜¯å¦ä½¿ç”¨éƒ½ä¼šåˆ›å»ºå®ä¾‹ï¼Œå¯èƒ½é€ æˆå†…å­˜æµªè´¹
{% endnote %}

## ğŸ˜´ æ‡’æ±‰å¼å®ç°

æ‡’æ±‰å¼è¡¨ç¤ºåœ¨ç¬¬ä¸€æ¬¡éœ€è¦åˆ›å»ºå®ä¾‹æ—¶æ‰ä¼šåˆ›å»ºï¼Œå¯ä»¥é¿å…å†…å­˜æµªè´¹ã€‚

### æ–¹å¼ä¸€ï¼šçº¿ç¨‹ä¸å®‰å…¨

æœ€åŸºç¡€çš„æ‡’æ±‰å¼å®ç°ï¼š

```java
class Demo03 {
    private static Demo03 instance;
    
    private Demo03() {
    }
 
    // å¯¹å¤–æä¾›ä¸€ä¸ªè·å–å®ä¾‹çš„æ–¹æ³•
    public static Demo03 getInstance() {
        // åˆ¤æ–­è¯¥å®ä¾‹æ˜¯å¦å·²ç»å­˜åœ¨äº†
        // å¦‚æœå­˜åœ¨äº†ï¼Œå°±ç›´æ¥è¿”å›å½“å‰å®ä¾‹
        if (instance == null) {
            instance = new Demo03();
        }
        return instance;
    }
}
 
class Main {
    public static void main(String[] args) {
        Demo03 instance = Demo03.getInstance();
        Demo03 instance1 = Demo03.getInstance();
        System.out.println(instance == instance1);
        System.out.println(instance.hashCode());
        System.out.println(instance1.hashCode());
    }
}
```

{% note danger %}
**çº¿ç¨‹å®‰å…¨é—®é¢˜**ï¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤šä¸ªå®ä¾‹ï¼
{% endnote %}

**å¤šçº¿ç¨‹æµ‹è¯•ä»£ç ï¼š**

```java
class Demo03 {
    private static Demo03 instance;
    
    private Demo03() {
    }
 
    public static Demo03 getInstance() {
        if (instance == null) {
            instance = new Demo03();
        }
        return instance;
    }
}
 
class Thread01 extends Thread {
    @Override
    public void run() {
        Demo03 instance = Demo03.getInstance();
        System.out.println(instance);
    }
}
 
class Thread02 extends Thread {
    @Override
    public void run() {
        Demo03 instance = Demo03.getInstance();
        System.out.println(instance);
    }
}
 
class Main {
    public static void main(String[] args) {
        Thread01 thread01 = new Thread01();
        Thread02 thread02 = new Thread02();
        thread01.start();
        thread02.start();
    }
}
```

**è¿è¡Œç»“æœï¼š**
```
top.lukeewin.basics.demo07.Demo03@5f1db1c2
top.lukeewin.basics.demo07.Demo03@ddbeecd
```

å¯ä»¥çœ‹åˆ°åˆ›å»ºäº†ä¸¤ä¸ªä¸åŒçš„å®ä¾‹ï¼

### æ–¹å¼äºŒï¼šçº¿ç¨‹å®‰å…¨ - synchronizedåŒæ­¥é”

ä½¿ç”¨ `synchronized` å…³é”®å­—è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š

```java
class Demo03 {
    private static Demo03 instance;
    
    private Demo03() {
    }
 
    // ä½¿ç”¨synchronizedå…³é”®å­—ä¿è¯çº¿ç¨‹å®‰å…¨
    public static synchronized Demo03 getInstance() {
        if (instance == null) {
            instance = new Demo03();
        }
        return instance;
    }
}
```

{% note warning %}
**æ€§èƒ½é—®é¢˜**ï¼šsynchronizedä¼šé™ä½æ€§èƒ½ï¼Œæ¯æ¬¡è°ƒç”¨getInstance()éƒ½éœ€è¦åŒæ­¥ã€‚
{% endnote %}

### æ–¹å¼ä¸‰ï¼šåŒé‡æ£€æŸ¥é”ï¼ˆæ¨èï¼‰

ä¼˜åŒ–åŒæ­¥æ€§èƒ½çš„æœ€ä½³å®è·µï¼š

```java
class Demo03 {
    // æ³¨æ„ï¼šå¿…é¡»ä½¿ç”¨volatileå…³é”®å­—
    private static volatile Demo03 instance;
    
    private Demo03() {
    }
 
    // åŒé‡æ£€æŸ¥é”
    public static Demo03 getInstance() {
        // ç¬¬ä¸€æ¬¡æ£€æŸ¥
        if (instance == null) {
            synchronized (Demo03.class) {
                // ç¬¬äºŒæ¬¡æ£€æŸ¥
                if (instance == null) {
                    instance = new Demo03();
                }
            }
        }
        return instance;
    }
}
```

{% note info %}
**åŒé‡æ£€æŸ¥é”è§£é‡Š**ï¼š
1. ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼šé¿å…ä¸å¿…è¦çš„åŒæ­¥
2. åŒæ­¥å—ï¼šä¿è¯çº¿ç¨‹å®‰å…¨
3. ç¬¬äºŒæ¬¡æ£€æŸ¥ï¼šé˜²æ­¢é‡å¤åˆ›å»º
4. `volatile` å…³é”®å­—ï¼šé˜²æ­¢æŒ‡ä»¤é‡æ’åº
{% endnote %}

### æ–¹å¼å››ï¼šé™æ€å†…éƒ¨ç±»ï¼ˆæ¨èï¼‰

åˆ©ç”¨ç±»åŠ è½½æœºåˆ¶ä¿è¯çº¿ç¨‹å®‰å…¨ï¼š

```java
public class Singleton01 {
    private Singleton01() {
    }
 
    // é™æ€å†…éƒ¨ç±»
    private static class SingletonHolder {
        private static final Singleton01 INSTANCE = new Singleton01();
    }
 
    public static Singleton01 getInstance() {
        return SingletonHolder.INSTANCE;
    }
}
 
class Main03 {
    public static void main(String[] args) {
        Singleton01 instance = Singleton01.getInstance();
        Singleton01 instance1 = Singleton01.getInstance();
        System.out.println(instance == instance1);
        System.out.println(instance.hashCode());
        System.out.println(instance1.hashCode());
    }
}
```

{% note success %}
**é™æ€å†…éƒ¨ç±»ä¼˜ç‚¹**ï¼š
- çº¿ç¨‹å®‰å…¨ï¼ˆç”±JVMä¿è¯ï¼‰
- æ‡’åŠ è½½ï¼ˆåªæœ‰è°ƒç”¨getInstance()æ—¶æ‰åŠ è½½å†…éƒ¨ç±»ï¼‰
- æ€§èƒ½é«˜ï¼ˆæ— éœ€åŒæ­¥ï¼‰
{% endnote %}

### æ–¹å¼äº”ï¼šæšä¸¾å®ç°ï¼ˆæœ€ä¼˜é›…ï¼‰

ä½¿ç”¨æšä¸¾ç±»å‹åˆ›å»ºå•ä¾‹ï¼Œè¿™æ˜¯ã€ŠEffective Javaã€‹æ¨èçš„æ–¹æ³•ï¼š

```java
public enum Singleton {
    INSTANCE;
    
    // å¯ä»¥æ·»åŠ å…¶ä»–æ–¹æ³•
    public void doSomething() {
        System.out.println("æ‰§è¡Œä¸šåŠ¡é€»è¾‘");
    }
}
 
class Main02 {
    public static void main(String[] args) {
        Singleton instance = Singleton.INSTANCE;
        Singleton instance1 = Singleton.INSTANCE;
        System.out.println(instance == instance1);
        
        // è°ƒç”¨ä¸šåŠ¡æ–¹æ³•
        instance.doSomething();
    }
}
```

{% note success %}
**æšä¸¾å®ç°ä¼˜ç‚¹**ï¼š
- ä»£ç ç®€æ´
- çº¿ç¨‹å®‰å…¨
- é˜²æ­¢åå°„æ”»å‡»
- é˜²æ­¢åºåˆ—åŒ–ç ´åå•ä¾‹
{% endnote %}

## ğŸ—‚ï¸ é«˜çº§å®ç°ï¼šå®¹å™¨å¼å•ä¾‹

### æ–¹å¼å…­ï¼šä½¿ç”¨Mapé›†åˆç®¡ç†å¤šä¸ªå•ä¾‹

å½“éœ€è¦ç®¡ç†å¤šä¸ªä¸åŒç±»å‹çš„å•ä¾‹æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å®¹å™¨æ¨¡å¼ï¼š

```java
public class SingletonManager {
    // å®šä¹‰ä¸€ä¸ªé™æ€Mapé›†åˆå­˜å‚¨å•ä¾‹
    private static Map<String, Object> objectMap = new HashMap<>();
 
    private SingletonManager() {
    }
 
    // æ³¨å†Œå•ä¾‹
    public static void registerSingleton(String singletonName, Object instance) {
        if (!objectMap.containsKey(singletonName)) {
            objectMap.put(singletonName, instance);
        }
    }
 
    // è·å–å•ä¾‹
    public static Object getInstance(String singletonName) {
        return objectMap.get(singletonName);
    }
}
 
class Student {
    private String name;
    private int age;
    
    public Student(String name, int age) {
        this.name = name;
        this.age = age;
    }
    
    // getterå’Œsetteræ–¹æ³•çœç•¥
}
 
class Main04 {
    public static void main(String[] args) {
        // æ³¨å†Œå•ä¾‹
        SingletonManager.registerSingleton("student", new Student("å¼ ä¸‰", 18));
        
        // è·å–å•ä¾‹
        Object bean01 = SingletonManager.getInstance("student");
        Object bean02 = SingletonManager.getInstance("student");
        
        System.out.println(bean01 == bean02); // true
        System.out.println(bean01.hashCode());
        System.out.println(bean02.hashCode());
    }
}
```

## ğŸ“‹ å„ç§å®ç°æ–¹å¼å¯¹æ¯”

| å®ç°æ–¹å¼ | çº¿ç¨‹å®‰å…¨ | æ‡’åŠ è½½ | æ€§èƒ½ | æ¨èåº¦ | é€‚ç”¨åœºæ™¯ |
|:---|:---:|:---:|:---:|:---:|:---|
| é¥¿æ±‰å¼-é™æ€å˜é‡ | âœ… | âŒ | é«˜ | â­â­â­ | ç¡®å®šä¼šä½¿ç”¨çš„åœºæ™¯ |
| é¥¿æ±‰å¼-é™æ€ä»£ç å— | âœ… | âŒ | é«˜ | â­â­â­ | éœ€è¦å¤æ‚åˆå§‹åŒ–é€»è¾‘ |
| æ‡’æ±‰å¼-çº¿ç¨‹ä¸å®‰å…¨ | âŒ | âœ… | é«˜ | â­ | å•çº¿ç¨‹ç¯å¢ƒ |
| æ‡’æ±‰å¼-synchronized | âœ… | âœ… | ä½ | â­â­ | ä¸æ¨èä½¿ç”¨ |
| åŒé‡æ£€æŸ¥é” | âœ… | âœ… | é«˜ | â­â­â­â­ | é«˜å¹¶å‘ç¯å¢ƒ |
| é™æ€å†…éƒ¨ç±» | âœ… | âœ… | é«˜ | â­â­â­â­â­ | å¤§å¤šæ•°åœºæ™¯ |
| æšä¸¾å®ç° | âœ… | âŒ | é«˜ | â­â­â­â­â­ | æœ€å®‰å…¨çš„å®ç° |

## ğŸ›¡ï¸ å•ä¾‹æ¨¡å¼çš„å®‰å…¨é—®é¢˜

### åå°„æ”»å‡»

```java
// åå°„ç ´åå•ä¾‹
Constructor<Singleton01> constructor = Singleton01.class.getDeclaredConstructor();
constructor.setAccessible(true);
Singleton01 instance1 = constructor.newInstance();
Singleton01 instance2 = Singleton01.getInstance();
System.out.println(instance1 == instance2); // false
```

**é˜²æŠ¤æªæ–½**ï¼šåœ¨æ„é€ å‡½æ•°ä¸­æ·»åŠ æ£€æŸ¥

```java
private Singleton01() {
    if (SingletonHolder.INSTANCE != null) {
        throw new RuntimeException("ä¸å…è®¸åˆ›å»ºå¤šä¸ªå®ä¾‹");
    }
}
```

### åºåˆ—åŒ–é—®é¢˜

åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¼šç ´åå•ä¾‹ï¼Œè§£å†³æ–¹æ³•æ˜¯æ·»åŠ  `readResolve()` æ–¹æ³•ï¼š

```java
private Object readResolve() {
    return getInstance();
}
```

{% note info %}
**æšä¸¾å®ç°å¤©ç„¶é˜²æŠ¤**ï¼šæšä¸¾ç±»å‹å¤©ç„¶é˜²æ­¢åå°„å’Œåºåˆ—åŒ–æ”»å‡»ï¼Œè¿™ä¹Ÿæ˜¯æ¨èä½¿ç”¨æšä¸¾çš„é‡è¦åŸå› ã€‚
{% endnote %}

## ğŸ¯ æœ€ä½³å®è·µå»ºè®®

1. **é¦–é€‰æšä¸¾å®ç°**ï¼šæœ€å®‰å…¨ã€æœ€ç®€æ´
2. **æ¬¡é€‰é™æ€å†…éƒ¨ç±»**ï¼šæ€§èƒ½å¥½ã€æ‡’åŠ è½½
3. **é¿å…synchronizedæ–¹æ³•**ï¼šæ€§èƒ½å·®
4. **æ³¨æ„volatileå…³é”®å­—**ï¼šåŒé‡æ£€æŸ¥é”å¿…é¡»ä½¿ç”¨
5. **è€ƒè™‘åºåˆ—åŒ–å®‰å…¨**ï¼šå®ç°readResolve()æ–¹æ³•

{% fold @å®Œæ•´çš„ç”Ÿäº§çº§å•ä¾‹å®ç°ç¤ºä¾‹ %}
```java
/**
 * ç”Ÿäº§çº§å•ä¾‹å®ç° - é™æ€å†…éƒ¨ç±»æ–¹å¼
 */
public class ProductionSingleton implements Serializable {
    private static final long serialVersionUID = 1L;
    
    private ProductionSingleton() {
        // é˜²æ­¢åå°„æ”»å‡»
        if (SingletonHolder.INSTANCE != null) {
            throw new RuntimeException("å•ä¾‹ç±»ä¸å…è®¸åˆ›å»ºå¤šä¸ªå®ä¾‹");
        }
    }
    
    private static class SingletonHolder {
        private static final ProductionSingleton INSTANCE = new ProductionSingleton();
    }
    
    public static ProductionSingleton getInstance() {
        return SingletonHolder.INSTANCE;
    }
    
    // é˜²æ­¢åºåˆ—åŒ–ç ´åå•ä¾‹
    private Object readResolve() {
        return getInstance();
    }
    
    // ä¸šåŠ¡æ–¹æ³•
    public void doSomething() {
        System.out.println("æ‰§è¡Œä¸šåŠ¡é€»è¾‘...");
    }
}
```
{% endfold %}

## ğŸ“ æ€»ç»“

å•ä¾‹æ¨¡å¼æ˜¯ä¸€ä¸ªçœ‹ä¼¼ç®€å•ä½†å®åˆ™å¤æ‚çš„è®¾è®¡æ¨¡å¼ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œéœ€è¦æ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©åˆé€‚çš„å®ç°æ–¹å¼ï¼š

- å¯¹äºä¸€èˆ¬åœºæ™¯ï¼Œæ¨èä½¿ç”¨**é™æ€å†…éƒ¨ç±»**å®ç°
- å¯¹äºå®‰å…¨è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ï¼Œæ¨èä½¿ç”¨**æšä¸¾**å®ç°
- å¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œå¯ä»¥è€ƒè™‘**åŒé‡æ£€æŸ¥é”**å®ç°

æŒæ¡å•ä¾‹æ¨¡å¼ä¸ä»…æœ‰åŠ©äºé¢è¯•ï¼Œæ›´é‡è¦çš„æ˜¯èƒ½å¤Ÿåœ¨å®é™…é¡¹ç›®ä¸­æ­£ç¡®ä½¿ç”¨ï¼Œé¿å…å¸¸è§çš„çº¿ç¨‹å®‰å…¨é—®é¢˜å’Œæ€§èƒ½é™·é˜±ã€‚

å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿå¸®åŠ©ä½ å½»åº•ç†è§£å•ä¾‹æ¨¡å¼çš„å„ç§å®ç°æ–¹å¼å’Œä½¿ç”¨åœºæ™¯ï¼ ğŸ’ª